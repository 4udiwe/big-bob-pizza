# Payment Service

Сервис обработки платежей в системе Big Bob Pizza.

## Описание

Payment Service отвечает за обработку платежей за заказы. Сервис слушает события создания заказов из Kafka и предоставляет API для проведения оплаты.

## API Документация

Полная документация API доступна через Swagger UI:
- **Swagger UI**: http://localhost:8081/swagger/index.html
- **OpenAPI Spec**: см. `docs/swagger.json` (генерируется командой `swag init`)

### Основные эндпоинты

- `POST /payments` - Провести оплату заказа
- `GET /payments` - Получить список всех платежей (с пагинацией и фильтрацией)
- `GET /payments/{id}` - Получить платеж по ID
- `GET /payments/order/{orderId}` - Получить платеж по ID заказа
- `GET /health` - Health check

## Особенности работы

### Обработка платежей

**Важно**: Сервис использует симуляцию платежного шлюза:
- **90% платежей** обрабатываются успешно
- **10% платежей** отклоняются с причиной "insufficient funds"

В реальной системе здесь был бы вызов внешнего платежного шлюза (Stripe, PayPal и т.д.).

### Доступность заказов для оплаты

Заказы доступны для оплаты только в течение **30 минут** после создания:
- При получении события `order.created` заказ сохраняется в таблицу `order_cache`
- Запись автоматически истекает через 30 минут (поле `expires_at`)
- После обработки платежа заказ удаляется из кэша

### События Kafka

Сервис слушает:
- `order.created` из топика `order.events` - сохраняет заказ в кэш для оплаты

Сервис публикует в топик `payment.events`:
- `payment.success` - при успешной оплате
- `payment.failed` - при неудачной оплате

### Outbox Pattern

Все события публикуются через outbox pattern для гарантированной доставки:
- События записываются в таблицу `outbox` в той же транзакции, что и создание/обновление платежа
- Outbox Worker периодически публикует события в Kafka
- При ошибке публикации события помечаются как failed и перевыставляются позже

### Статусы платежа

- `pending` - платеж создан, ожидает обработки
- `completed` - платеж успешно обработан
- `failed` - платеж отклонен (с указанием причины в `failureReason`)

## Фильтрация и пагинация

Эндпоинт `GET /payments` поддерживает:
- **Пагинацию**: `limit` (по умолчанию 20, максимум 100) и `offset` (по умолчанию 0)
- **Фильтрацию по статусу**: `?status=completed`
- **Фильтрацию по пользователю**: `?userId={uuid}`

Примеры:
- `GET /payments?limit=10&offset=0&status=completed`
- `GET /payments?userId=123e4567-e89b-12d3-a456-426614174000`

## Запуск

```bash
# Локально
go run cmd/main.go

# Через Docker Compose (из корня проекта)
docker-compose up payment-service
```

## Конфигурация

Конфигурация находится в `config/config.yaml`. Основные параметры:
- `http.port` - порт HTTP сервера (по умолчанию 8081)
- `postgres.url` - строка подключения к PostgreSQL
- `kafka.brokers` - список брокеров Kafka
- `kafka.topics.order_events` - топик для получения событий заказов
- `kafka.topics.payment_events` - топик для публикации событий платежей
- `outbox.*` - настройки outbox worker

## База данных

Миграции находятся в `internal/database/migrations/` и выполняются автоматически при запуске сервиса.

Основные таблицы:
- `payments` - платежи
- `payment_status` - справочник статусов платежей
- `order_cache` - кэш заказов, доступных для оплаты (TTL 30 минут)
- `outbox` - события для публикации
- `outbox_status` - справочник статусов outbox

## Взаимодействие с другими сервисами

### Order Service

Payment Service получает информацию о созданных заказах через Kafka событие `order.created` и сохраняет их в кэш. После успешной оплаты публикуется событие `payment.success`, которое обрабатывается Order Service для обновления статуса заказа.

### Workflow оплаты

1. Order Service создает заказ и публикует `order.created`
2. Payment Service получает событие и сохраняет заказ в `order_cache`
3. Клиент вызывает `POST /payments` для оплаты
4. Payment Service проверяет доступность заказа (не истек ли срок 30 минут)
5. Payment Service создает платеж и симулирует обработку
6. При успехе публикуется `payment.success`, при ошибке - `payment.failed`
7. Order Service получает событие и обновляет статус заказа

